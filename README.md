# üìã Dashboard Estoque Backend - Documenta√ß√£o Completa

## üéØ Vis√£o Geral

Sistema backend Django REST API para integra√ß√£o completa com o ERP **Protheus Oracle**, fornecendo dados de estoque, movimenta√ß√µes, vendas e libera√ß√µes atrav√©s de endpoints RESTful otimizados.

### üèóÔ∏è Arquitetura

- **Framework:** Django 5.2.3 + Django REST Framework 3.16.0
- **Banco de Dados:** Oracle (Protheus) + SQLite (Django)
- **Integra√ß√£o:** Conex√£o direta com tabelas Protheus via oracledb
- **Padr√£o:** MVS (Model-View-Service) com database routing

---

## üöÄ Funcionalidades Principais

### ‚úÖ M√≥dulos Implementados:
- üì¶ **Estoque (SB1/SB2)** - Produtos e saldos atuais
- üîÑ **Movimenta√ß√µes (SD3)** - Hist√≥rico de entradas/sa√≠das
- üìà **Vendas (SC5/SC6)** - Pedidos e faturamento
- üöö **Libera√ß√µes (SC9)** - Status de entregas e bloqueios

### ‚úÖ Caracter√≠sticas T√©cnicas:
- **Pagina√ß√£o customizada** com metadados completos
- **Filtros din√¢micos** por filial, local, per√≠odo
- **Status calculados** em tempo real
- **Queries otimizadas** para performance Oracle
- **Tratamento robusto** de erros e timeouts

---

## üîó API Endpoints Dispon√≠veis

### üì¶ 1. Estoque (SB1/SB2)

#### `GET /api/v1/stocks/`
**Descri√ß√£o:** Dados de estoque atual com informa√ß√µes de produto

**Par√¢metros:**
- `filial` (str, opcional) - C√≥digo da filial (ex: "01")
- `armazem` (str, opcional) - C√≥digo do armaz√©m (ex: "01") 
- `page` (int, opcional) - N√∫mero da p√°gina (padr√£o: 1)
- `page_size` (int, opcional) - Itens por p√°gina (padr√£o: 50, max: 1000)

**Resposta:**
```json
{
  "count": 2500,
  "next": "http://api/v1/stocks/?page=2",
  "previous": null,
  "total_pages": 50,
  "current_page": 1,
  "page_size": 50,
  "results": [
    {
      "code": "PROD001",
      "description": "PRODUTO EXEMPLO",
      "balance": 150.0,
      "filial": "01",
      "local": "01"
    }
  ]
}
```

**Fonte de Dados:** SB1010 (produtos) + SB2010 (saldos)

---

### üîÑ 2. Movimenta√ß√µes (SD3)

#### `GET /api/v1/stocks_moviment/`
**Descri√ß√£o:** Hist√≥rico de movimenta√ß√µes de estoque

**Par√¢metros:**
- `filial` (str, opcional) - C√≥digo da filial
- `local` (str, opcional) - C√≥digo do armaz√©m
- `page` (int, opcional) - Pagina√ß√£o
- `page_size` (int, opcional) - Itens por p√°gina

**Resposta:**
```json
{
  "count": 10000,
  "results": [
    {
      "code": "PROD001",
      "movement_type": "501",
      "date": "2024-12-15",
      "quantity": 25.0,
      "fiscal_code": "5102",
      "document": "000001234",
      "location": "01",
      "filial": "01"
    }
  ]
}
```

**Fonte de Dados:** SD3010 (movimenta√ß√µes) + SB1010 (produtos)

---

### üìà 3. Vendas (SC5/SC6)

#### `GET /api/v1/sales/`
**Descri√ß√£o:** Dados de vendas combinados com movimenta√ß√µes de sa√≠da

**Par√¢metros:**
- `meses` (int, opcional) - Per√≠odo de an√°lise em meses (padr√£o: 4)
- `filial` (str, opcional) - C√≥digo da filial
- `armazem` (str, opcional) - C√≥digo do armaz√©m

**Resposta:**
```json
{
  "results": [
    {
      "code": "PROD001",
      "description": "PRODUTO EXEMPLO",
      "quantity": 100.0,
      "value": 2500.00,
      "filial": "01",
      "local": "01"
    }
  ]
}
```

**Fonte de Dados:** SC5010 (pedidos) + SC6010 (itens) + SD3010 (movimenta√ß√µes)

---

### üöö 4. Libera√ß√µes/Entregas (SC9) - **NOVO**

#### `GET /api/v1/deliveries/`
**Descri√ß√£o:** Libera√ß√µes de pedidos com status completo

**Par√¢metros:**
- `filial` (str, opcional) - C√≥digo da filial
- `local` (str, opcional) - C√≥digo do armaz√©m
- `days` (int, opcional) - √öltimos N dias (padr√£o: 30)
- `page` (int, opcional) - Pagina√ß√£o
- `page_size` (int, opcional) - Itens por p√°gina

**Resposta:**
```json
{
  "count": 150,
  "results": [
    {
      "pedido": "123456",
      "item": "01",
      "sequencia": "001",
      "produto": "PROD001",
      "descricao": "PRODUTO EXEMPLO",
      "quantidade_liberada": 10.0,
      "preco_venda": 25.50,
      "valor_total": 255.00,
      "data_liberacao": "2024-12-15",
      "local": "01",
      "lote": "L001",
      "data_validade": "2025-06-15",
      "ordem_separacao": "OS001",
      "nota_fiscal": "000123",
      "serie_nf": "1",
      "status_liberacao": "FATURADO",
      "bloqueio_estoque": "",
      "bloqueio_credito": "",
      "filial": "01"
    }
  ]
}
```

#### `GET /api/v1/deliveries/status/`
**Descri√ß√£o:** Resumo quantitativo por status de libera√ß√£o

**Par√¢metros:**
- `filial` (str, opcional) - C√≥digo da filial
- `days` (int, opcional) - Per√≠odo em dias (padr√£o: 7)

**Resposta:**
```json
{
  "success": true,
  "count": 5,
  "data": [
    {
      "status": "FATURADO",
      "quantidade": 45,
      "valor_total": 12500.00
    },
    {
      "status": "LIBERADO",
      "quantidade": 23,
      "valor_total": 5800.00
    },
    {
      "status": "BLOQ_ESTOQUE",
      "quantidade": 8,
      "valor_total": 2100.00
    }
  ]
}
```

#### `GET /api/v1/deliveries/pending/`
**Descri√ß√£o:** Libera√ß√µes prontas para faturamento (sem bloqueios)

**Par√¢metros:**
- `filial` (str, opcional) - C√≥digo da filial
- `local` (str, opcional) - C√≥digo do armaz√©m

**Resposta:**
```json
{
  "count": 25,
  "results": [
    {
      "filial": "01",
      "pedido": "123456",
      "produto": "PROD001",
      "descricao": "PRODUTO EXEMPLO",
      "local": "01",
      "total_liberado": 50.0,
      "valor_total": 1275.00,
      "primeira_liberacao": "2024-12-10",
      "ultima_liberacao": "2024-12-15",
      "total_itens": 3
    }
  ]
}
```

**Fonte de Dados:** SC9010 (libera√ß√µes) + SB1010 (produtos)

---

## üìä Status de Libera√ß√£o (SC9)

### üéØ Status Calculados Dinamicamente:

| Status | Descri√ß√£o | Condi√ß√£o SQL |
|--------|-----------|--------------|
| **FATURADO** | J√° possui nota fiscal | `C9_NFISCAL != ' '` |
| **LIBERADO** | Pronto para faturar | `C9_OK = 'S'` e sem bloqueios |
| **BLOQ_ESTOQUE** | Bloqueado por estoque | `C9_BLEST != '  '` |
| **BLOQ_CREDITO** | Bloqueado por cr√©dito | `C9_BLCRED != '  '` |
| **PENDENTE** | Em an√°lise | Demais casos |

### üîç Campos Principais SC9:

#### Identifica√ß√£o:
- `C9_FILIAL` - Filial
- `C9_PEDIDO` - N√∫mero do pedido
- `C9_ITEM` - Item do pedido
- `C9_SEQUEN` - Sequ√™ncia da libera√ß√£o
- `C9_PRODUTO` - C√≥digo do produto

#### Quantidades e Valores:
- `C9_QTDLIB` - Quantidade liberada
- `C9_PRCVEN` - Pre√ßo de venda unit√°rio
- `C9_DATALIB` - Data da libera√ß√£o

#### Controle e Rastreamento:
- `C9_LOCAL` - Local/armaz√©m
- `C9_LOTECTL` - Lote
- `C9_DTVALID` - Data de validade
- `C9_ORDSEP` - Ordem de separa√ß√£o
- `C9_NFISCAL` - Nota fiscal gerada
- `C9_SERIENF` - S√©rie da nota fiscal

#### Status e Bloqueios:
- `C9_BLEST` - Bloqueio de estoque
- `C9_BLCRED` - Bloqueio de cr√©dito
- `C9_OK` - Libera√ß√£o confirmada

---

## üõ†Ô∏è Estrutura T√©cnica

### üìÅ Estrutura de Arquivos:

```
dashboard-estoque-backend/
‚îú‚îÄ‚îÄ core/
‚îÇ   ‚îú‚îÄ‚îÄ settings.py           # Configura√ß√µes Django + Oracle
‚îÇ   ‚îú‚îÄ‚îÄ urls.py              # URLs principais
‚îÇ   ‚îú‚îÄ‚îÄ db_router.py         # Roteamento de banco de dados
‚îÇ   ‚îî‚îÄ‚îÄ monkey_patch_oracle.py # Patch para compatibilidade Oracle
‚îú‚îÄ‚îÄ protheus/
‚îÇ   ‚îú‚îÄ‚îÄ models.py            # Models das tabelas Protheus
‚îÇ   ‚îú‚îÄ‚îÄ services.py          # L√≥gica de neg√≥cio e queries SQL
‚îÇ   ‚îú‚îÄ‚îÄ views.py             # Views da API REST
‚îÇ   ‚îú‚îÄ‚îÄ serializers.py       # Serializa√ß√£o de dados
‚îÇ   ‚îú‚îÄ‚îÄ urls.py              # URLs do app protheus
‚îÇ   ‚îú‚îÄ‚îÄ filters.py           # Filtros personalizados
‚îÇ   ‚îî‚îÄ‚îÄ migrations/          # Migra√ß√µes Django
‚îú‚îÄ‚îÄ manage.py
‚îú‚îÄ‚îÄ requirements.txt
‚îî‚îÄ‚îÄ .gitignore
```

### üóÑÔ∏è Configura√ß√£o de Banco de Dados:

```python
DATABASES = {
    'default': {
        'ENGINE': 'django.db.backends.sqlite3',
        'NAME': BASE_DIR / 'db.sqlite3',
    },
    'protheus': {
        'ENGINE': 'django.db.backends.oracle',
        'NAME': '192.168.0.12:1521/ORCL',
        'USER': 'P11PROD',
        'PASSWORD': 'P11PROD',
    },
}

DATABASE_ROUTERS = ['protheus.db_router.ProtheusRouter']
```

### üîÑ Database Router:

```python
class ProtheusRouter:
    def db_for_read(self, model, **hints):
        if model._meta.app_label == 'protheus':
            return 'protheus'
        return None
    
    def db_for_write(self, model, **hints):
        if model._meta.app_label == 'protheus':
            return 'protheus'
        return None
```

---

## üìã Models Implementados

### üè∑Ô∏è ProtheusSB1 (Produtos):
```python
class ProtheusSB1(models.Model):
    B1_FILIAL = models.CharField(max_length=2)
    B1_COD = models.CharField(max_length=15, primary_key=True)
    B1_DESC = models.CharField(max_length=100)
    B1_TIPO = models.CharField(max_length=2)
    B1_UM = models.CharField(max_length=2)
    B1_GRUPO = models.CharField(max_length=4)
    
    class Meta:
        managed = False
        db_table = 'SB1010'
```

### üì¶ ProtheusSB2 (Saldos):
```python
class ProtheusSB2(models.Model):
    B2_FILIAL = models.CharField(max_length=2)
    B2_COD = models.CharField(max_length=15, primary_key=True)
    B2_LOCAL = models.CharField(max_length=2)
    B2_QATU = models.FloatField()
    B2_RESERVA = models.FloatField()
    B2_QPEDVEN = models.FloatField()
    
    class Meta:
        managed = False
        db_table = 'SB2010'
```

### üîÑ ProtheusSD3 (Movimenta√ß√µes):
```python
class ProtheusSD3(models.Model):
    D3_FILIAL = models.CharField(max_length=2)
    D3_COD = models.CharField(max_length=15, primary_key=True)
    D3_TM = models.CharField(max_length=2)
    D3_EMISSAO = models.DateField()
    D3_QUANT = models.FloatField()
    D3_CF = models.CharField(max_length=10)
    D3_DOC = models.CharField(max_length=9)
    D3_LOCAL = models.CharField(max_length=2)
    
    class Meta:
        managed = False
        db_table = 'SD3010'
```

### üöö ProtheusSC9 (Libera√ß√µes) - **NOVO**:
```python
class ProtheusSC9(models.Model):
    C9_FILIAL = models.CharField(max_length=2)
    C9_PEDIDO = models.CharField(max_length=6)
    C9_ITEM = models.CharField(max_length=2)
    C9_SEQUEN = models.CharField(max_length=3)
    C9_PRODUTO = models.CharField(max_length=15)
    C9_QTDLIB = models.FloatField()
    C9_PRCVEN = models.FloatField()
    C9_DATALIB = models.DateField(null=True, blank=True)
    C9_LOCAL = models.CharField(max_length=2)
    C9_LOTECTL = models.CharField(max_length=10, blank=True, null=True)
    C9_DTVALID = models.DateField(null=True, blank=True)
    C9_ORDSEP = models.CharField(max_length=6, blank=True, null=True)
    C9_BLEST = models.CharField(max_length=2, blank=True, null=True)
    C9_BLCRED = models.CharField(max_length=2, blank=True, null=True)
    C9_OK = models.CharField(max_length=2, blank=True, null=True)
    C9_NFISCAL = models.CharField(max_length=9, blank=True, null=True)
    C9_SERIENF = models.CharField(max_length=3, blank=True, null=True)
    
    class Meta:
        managed = False
        db_table = 'SC9010'
    
    @property
    def status_liberacao(self):
        if self.C9_NFISCAL and self.C9_NFISCAL.strip():
            return 'FATURADO'
        elif self.C9_BLEST and self.C9_BLEST.strip():
            return 'BLOQ_ESTOQUE'
        elif self.C9_BLCRED and self.C9_BLCRED.strip():
            return 'BLOQ_CREDITO'
        elif self.C9_OK and self.C9_OK.strip() == 'S':
            return 'LIBERADO'
        else:
            return 'PENDENTE'
```

---

## ‚öôÔ∏è Services e Queries

### üîç Exemplo de Query Otimizada (SC9):

```sql
SELECT 
    SC9.C9_FILIAL as filial,
    SC9.C9_PEDIDO as pedido,
    SC9.C9_PRODUTO as produto,
    SB1.B1_DESC as descricao,
    SC9.C9_QTDLIB as quantidade_liberada,
    SC9.C9_PRCVEN as preco_venda,
    (SC9.C9_QTDLIB * SC9.C9_PRCVEN) as valor_total,
    SC9.C9_DATALIB as data_liberacao,
    SC9.C9_NFISCAL as nota_fiscal,
    
    -- STATUS CALCULADO
    CASE 
        WHEN SC9.C9_NFISCAL IS NOT NULL AND SC9.C9_NFISCAL != ' ' THEN 'FATURADO'
        WHEN SC9.C9_BLEST IS NOT NULL AND SC9.C9_BLEST != '  ' THEN 'BLOQ_ESTOQUE'
        WHEN SC9.C9_BLCRED IS NOT NULL AND SC9.C9_BLCRED != '  ' THEN 'BLOQ_CREDITO'
        WHEN SC9.C9_OK = 'S' THEN 'LIBERADO'
        ELSE 'PENDENTE'
    END as status_liberacao
    
FROM SC9010 SC9
LEFT JOIN SB1010 SB1 ON (
    SC9.C9_FILIAL = SB1.B1_FILIAL 
    AND SC9.C9_PRODUTO = SB1.B1_COD
    AND SB1.D_E_L_E_T_ = ' '
)
WHERE SC9.D_E_L_E_T_ = ' '
AND SC9.C9_QTDLIB > 0
AND SC9.C9_DATALIB >= SYSDATE - :days
ORDER BY SC9.C9_DATALIB DESC
```

### üéØ Caracter√≠sticas das Queries:
- **JOINs otimizados** entre tabelas relacionadas
- **Filtros de performance** (D_E_L_E_T_ = ' ')
- **C√°lculos em SQL** para melhor performance
- **Pagina√ß√£o eficiente** com ROW_NUMBER() / LIMIT
- **Tratamento de NULL** com COALESCE/CASE

---

## üîß Configura√ß√£o e Deploy

### üì¶ Depend√™ncias (requirements.txt):
```txt
Django==5.2.3
djangorestframework==3.16.0
django-cors-headers==4.7.0
django-filter==25.1
oracledb==3.1.1
pandas==2.3.0
openpyxl==3.1.5
python-dateutil==2.9.0.post0
pytz==2025.2
```

### üöÄ Comandos de Instala√ß√£o:
```bash
# Instalar depend√™ncias
pip install -r requirements.txt

# Aplicar migra√ß√µes
python manage.py migrate

# Executar servidor
python manage.py runserver
```

### üîê Configura√ß√µes de Seguran√ßa:
```python
# Para produ√ß√£o, usar vari√°veis de ambiente:
DATABASES = {
    'protheus': {
        'ENGINE': 'django.db.backends.oracle',
        'NAME': os.environ.get('ORACLE_DSN'),
        'USER': os.environ.get('ORACLE_USER'),
        'PASSWORD': os.environ.get('ORACLE_PASSWORD'),
    },
}

# CORS para produ√ß√£o:
CORS_ALLOWED_ORIGINS = [
    "https://seu-frontend.com",
]
```

---

## üìà Performance e Otimiza√ß√µes

### ‚ö° Otimiza√ß√µes Implementadas:
- **Conex√£o direta Oracle** sem ORM pesado
- **Queries SQL nativas** otimizadas
- **Pagina√ß√£o eficiente** com LIMIT/OFFSET
- **√çndices impl√≠citos** nas chaves prim√°rias
- **Filtros por per√≠odo** para reduzir dataset
- **CORS otimizado** para requests cross-origin

### üìä M√©tricas Esperadas:
- **Estoque:** ~2.500 produtos, resposta < 1s
- **Movimenta√ß√µes:** ~10.000 registros/m√™s, resposta < 2s
- **Libera√ß√µes SC9:** ~500 registros/dia, resposta < 1s
- **Pagina√ß√£o:** 50-1000 itens/p√°gina otimizada

---

## üîç Filtros e Par√¢metros

### üéõÔ∏è Filtros Dispon√≠veis:

| Endpoint | Par√¢metros | Exemplo |
|----------|------------|---------|
| `/stocks/` | `filial`, `armazem`, `page`, `page_size` | `?filial=01&armazem=01` |
| `/stocks_moviment/` | `filial`, `local`, `page`, `page_size` | `?filial=01&page_size=100` |
| `/sales/` | `meses`, `filial`, `armazem` | `?meses=6&filial=01` |
| `/deliveries/` | `filial`, `local`, `days`, `page`, `page_size` | `?days=15&filial=01` |
| `/deliveries/status/` | `filial`, `days` | `?days=7&filial=01` |
| `/deliveries/pending/` | `filial`, `local` | `?filial=01&local=01` |

### üîé Filtros Especiais:
- **Per√≠odo temporal:** `days`, `meses` para an√°lises espec√≠ficas
- **Localiza√ß√£o:** `filial`, `local`, `armazem` para segmenta√ß√£o
- **Pagina√ß√£o:** `page`, `page_size` para performance
- **Status din√¢micos:** Calculados automaticamente

---

## üö® Tratamento de Erros

### ‚ùå C√≥digos de Erro:

| C√≥digo | Descri√ß√£o | Solu√ß√£o |
|--------|-----------|---------|
| **500** | Erro de conex√£o Oracle | Verificar credenciais e rede |
| **404** | Endpoint n√£o encontrado | Verificar URL da API |
| **400** | Par√¢metros inv√°lidos | Verificar formato dos filtros |
| **408** | Timeout na query | Reduzir per√≠odo ou adicionar filtros |

### üõ†Ô∏è Logs e Debug:
```python
# Logs estruturados para debug:
logger.info(f"Query estoque: {sql}")
logger.info(f"Estoque: {len(results)} registros")

# Tratamento robusto:
try:
    cursor.execute(sql, params)
    return results
except Exception as e:
    logger.error(f"Erro na query: {e}")
    return []
```

---

## üéØ Casos de Uso

### üìä Dashboard de Gest√£o:
```bash
# Resumo de estoque
GET /api/v1/stocks/?page_size=1000

# Status das libera√ß√µes √∫ltimos 7 dias
GET /api/v1/deliveries/status/?days=7

# Libera√ß√µes pendentes por filial
GET /api/v1/deliveries/pending/?filial=01
```

### üìà Relat√≥rios Anal√≠ticos:
```bash
# Vendas √∫ltimos 6 meses
GET /api/v1/sales/?meses=6

# Movimenta√ß√µes por per√≠odo
GET /api/v1/stocks_moviment/?page_size=1000

# Libera√ß√µes com filtros espec√≠ficos
GET /api/v1/deliveries/?filial=01&days=30&page_size=500
```

### üîç Consultas Espec√≠ficas:
```bash
# Produtos espec√≠ficos
GET /api/v1/stocks/?B2_COD=PROD001

# Libera√ß√µes por pedido
GET /api/v1/deliveries/?pedido=123456

# Status consolidado
GET /api/v1/deliveries/status/?filial=01&days=30
```

---

## üÜï Changelog - Implementa√ß√£o SC9

### ‚ú® Novas Funcionalidades:
- **Model ProtheusSC9** completo para tabela SC9010
- **3 Novos Endpoints** de libera√ß√µes com filtros avan√ßados
- **Status din√¢micos** calculados em tempo real
- **Queries otimizadas** para performance Oracle
- **Serializers dedicados** para formata√ß√£o de dados

### üîß Melhorias T√©cnicas:
- **Conex√£o Oracle corrigida** (`connections['protheus']`)
- **Database routing** otimizado para m√∫ltiplas conex√µes
- **Tratamento de erros** robusto e estruturado
- **Pagina√ß√£o customizada** com metadados completos
- **Logging estruturado** para debug e monitoramento

### üóëÔ∏è Remo√ß√µes:
- **App uploads** removido (funcionalidade n√£o utilizada)
- **Views comentadas** limpas do c√≥digo
- **Depend√™ncias desnecess√°rias** removidas

---

## üèÅ Conclus√£o

O **Dashboard Estoque Backend** oferece uma **API REST completa e otimizada** para integra√ß√£o com o ERP Protheus, fornecendo dados em tempo real de:

- ‚úÖ **Estoque atual** com produtos e saldos
- ‚úÖ **Movimenta√ß√µes hist√≥ricas** de entrada/sa√≠da  
- ‚úÖ **Vendas e faturamento** consolidados
- ‚úÖ **Libera√ß√µes e entregas** com status din√¢micos

### üéØ Caracter√≠sticas Destacadas:
- **Performance otimizada** com queries SQL nativas
- **Flexibilidade total** com filtros din√¢micos
- **Escalabilidade** atrav√©s de pagina√ß√£o eficiente
- **Confiabilidade** com tratamento robusto de erros
- **Seguran√ßa** via database routing e valida√ß√µes

**Sistema pronto para produ√ß√£o, totalmente documentado e versionado no Git.** üöÄ
